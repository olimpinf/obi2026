#! /usr/bin/env sh

if $1
then
   STATE='%';
else
   STATE=$1;
fi

psql -d obi2025 -U obi <<EOF
SELECT DISTINCT school_answer_consulta_fase3 AS resp,
                school.school_id,
                LEFT(school_name,30),
                school_deleg_name,
                school_city,
                school_state as state,
                id
FROM            compet,
                school,
                school_extra
WHERE           compet_school_id=school.school_id
AND             compet_school_id=school_extra.school_id
AND             school.school_id=school_extra.school_id
AND             compet_classif_fase2
AND             school_site_phase3_ini=0
AND             compet_type  IN (1,2,7)
-- AND             school_city NOT IN
--                 (
--                        SELECT school_city
--                        FROM   school AS s,
--                               compet AS c
--                        WHERE  school_id=compet_school_id
--                        AND    compet_classif_fase2
--                        AND    compet_type IN (3,4,5,6)
-- 		)
AND             school_state ilike '${STATE}'
ORDER BY        school_answer_consulta_fase3,
                school_state,
                school_city,
                id;
EOF
